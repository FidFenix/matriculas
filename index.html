<!DOCTYPE html>
<html lang="es" ng-app="MyApp">
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.26/angular.min.js"></script>

</head>
<body ng-controller="MyController">
<div class="container">

<span id="googleSignIn">
<span id="signInButton">
</span>
</span>


<div class="panel-body">
<form name="coursesForm" ng-submit="send()">
<table class="table table-striped">
<tr>
<th> </th>
<th>Código</th>
<th>Nombre</th>
<th>Créditos</th>
<th>Semestre</th>
</tr>
<tr ng-repeat="course in courses">
<td><input type="checkbox" ng-model="selection.ids[course.id]" name="chosen" id="{{course.id}}" /></td>
<td>{{course.id}}</td>
<td>{{course.name}}</td>
<td>{{course.credits}}</td>
<td>{{course.semester}}</td>
</tr>
</table>
<button type="submit" class="btn btn-default">Matricular</button>
<pre ng-bind="selection.ids | json"></pre>
</form>
</div>

</div>

<script type="text/javascript">
(function() {
 var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
 po.src = 'https://apis.google.com/js/client:plusone.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
 })();
</script>

</body>
<script>
var app = angular.module("MyApp", []);

app.controller('MyController', function($scope, $http){
  $scope.signedIn = false;
  $scope.count = 0;
  $scope.cui = "";
  $scope.courses = [];
  $scope.selection = {ids:{1: false}};

  $scope.processAuth = function(authResult){
    if(authResult['access_token']){
      $scope.signedIn = true;
      $http({
        method: 'GET',
        url: 'matricula.php',
        params: {token: authResult['access_token']}
      }).success(function(data){
        $scope.courses = data;
      });
    }else if(authResult['error']){
      $scope.signedIn = false;
    }
  };
  $scope.signedInCallback = function(authResult){
    $scope.$apply(function(){
      $scope.processAuth(authResult);
    });
  };

  $scope.renderSignInButton = function() {
    gapi.sigin.render('signInButton',{
      'callback': $scope.signInCallback,
      'clientid': "792434456801-h437k4b8l1nkl0vu7hqqrtctknunq76p.apps.googleusercontent.com",
      'requestvisibleactions': 'http://schemas.google.com/AddActivity',
      'scope': 'https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/userinfo.email',
      'cookiepolicy': 'single_host_origin'
    });
  }

  $scope.start = function() {
    $scope.renderSignInButton();
  };

  $scope.query = function($cui){
    $http.get('matricula.php?cui='+$cui)
      .success(function(data, status, headers, config){
        $scope.courses = data;
      }).
      error(function(data, status, headers, config){
      });
  };
  $scope.send = function(){
    $http({
      method: 'GET',
      url: 'update.php',
      params:{ cui:$scope.cui, chosen: JSON.stringify($scope.selection.ids)}
    }).success(function(data){
        window.alert(data);
    });
  };
});
</script>
</html>
